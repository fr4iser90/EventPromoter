[
  {
    "id": "platform-email-check",
    "name": "üìß Has Email Content?",
    "type": "if",
    "parameters": {
      "conditions": {
        "boolean": [
          {
            "value1": "={{ $json.body?.email && typeof $json.body.email === 'object' }}",
            "value2": true
          }
        ]
      },
      "options": {
        "alwaysOutputData": true
      }
    },
    "position": [200, 600],
    "typeVersion": 2
  },
  {
    "id": "platform-email-prepare",
    "name": "üìß Prepare Email Data",
    "type": "code",
    "script": "email-prepare.js",
    "parameters": {
      "mode": "runOnceForEachItem"
    },
    "position": [400, 600],
    "typeVersion": 2
  },
  {
    "id": "platform-email-check-attachments",
    "name": "üìé Has Attachments?",
    "type": "if",
    "parameters": {
      "conditions": {
        "boolean": [
          {
            "value1": "={{ $json.email.attachments !== undefined && Array.isArray($json.email.attachments) && $json.email.attachments.length > 0 }}",
            "value2": true
          }
        ]
      }
    },
    "position": [600, 600],
    "typeVersion": 2
  },
  {
    "id": "platform-email-save-email-data",
    "name": "üíæ Save Email Data",
    "type": "code",
    "script": "email-save-data.js",
    "parameters": {
      "mode": "runOnceForEachItem"
    },
    "position": [800, 500],
    "typeVersion": 2
  },
  {
    "id": "platform-email-filter-attachments",
    "name": "üîç Filter Attachments per Group",
    "type": "code",
    "script": "email-filter-attachments.js",
    "parameters": {
      "mode": "runOnceForEachItem"
    },
    "position": [1000, 500],
    "typeVersion": 2
  },
  {
    "id": "platform-email-loop-attachments",
    "name": "üîÑ Loop Attachments",
    "type": "code",
    "script": "email-loop-attachments.js",
    "parameters": {
      "mode": "runOnceForEachItem"
    },
    "position": [1200, 500],
    "typeVersion": 2
  },
  {
    "id": "platform-email-download-attachment",
    "name": "‚¨áÔ∏è Download Attachment",
    "type": "httpRequest",
    "parameters": {
      "method": "GET",
      "url": "={{ $json.url }}",
      "options": {
        "response": {
          "response": {
            "responseFormat": "file"
          }
        }
      },
      "authentication": "none"
    },
      "position": [1400, 500],
    "typeVersion": 4.2
  },
  {
    "id": "platform-email-merge-attachments",
    "name": "üîó Merge Attachments",
    "type": "code",
    "script": "email-merge-attachments.js",
    "parameters": {
      "mode": "runOnceForAllItems"
    },
      "position": [1600, 500],
    "typeVersion": 2
  },
  {
    "id": "platform-email-send",
    "name": "üìß Send Email",
    "type": "emailSend",
    "parameters": {
      "fromEmail": "noreply@eventpromoter.com",
      "toEmail": "={{ $json.email.recipients || $json.email.group || 'user@example.com' }}",
      "subject": "={{ $json.email.subject }}",
      "html": "={{ $json.email.html }}",
      "attachments": "",
      "options": {
        "attachments": {
          "binaryProperty": {
            "__expression": "={{ Object.keys($binary).filter(k => k.startsWith('data')).join(',') || 'data' }}"
          }
        }
      }
    },
    "position": [1800, 500],
    "onError": "continueRegularOutput",
    "typeVersion": 2.1
  },
  {
    "id": "platform-email-send-no-attachments",
    "name": "üìß Send Email (No Attachments)",
    "type": "emailSend",
    "parameters": {
      "fromEmail": "noreply@eventpromoter.com",
      "toEmail": "={{ $json.email.recipients || 'user@example.com' }}",
      "subject": "={{ $json.email.subject }}",
      "html": "={{ $json.email.html }}"
    },
    "position": [800, 700],
    "onError": "continueRegularOutput",
    "typeVersion": 2.1
  },
  {
    "id": "platform-email-emit-started",
    "name": "üì° Emit Email Started",
    "type": "httpRequest",
    "parameters": {
      "method": "POST",
      "url": "={{ $json.callbackUrl || $json.metadata?.callbackUrl || 'http://localhost:3000/api/publish/event' }}",
      "sendBody": true,
      "specifyBody": "json",
      "jsonBody": "={{ { sessionId: $json.sessionId || $json.metadata?.sessionId || $json.metadata?.eventData?.sessionId, publishRunId: $json.publishRunId || $json.metadata?.publishRunId || $json.metadata?.eventData?.publishRunId, type: 'step_started', platform: 'email', method: 'n8n', step: 'publish.submit', message: 'Starting publish.submit via n8n', timestamp: $now.toISO() } }}",
      "options": {}
    },
    "position": [300, 540],
    "typeVersion": 4.2
  },
  {
    "id": "platform-email-emit-completed",
    "name": "‚úÖ Emit Email Completed",
    "type": "httpRequest",
    "parameters": {
      "method": "POST",
      "url": "={{ $json.callbackUrl || $json.metadata?.callbackUrl || 'http://localhost:3000/api/publish/event' }}",
      "sendBody": true,
      "specifyBody": "json",
      "jsonBody": "={{ { sessionId: $json.sessionId || $json.metadata?.sessionId || $json.metadata?.eventData?.sessionId, publishRunId: $json.publishRunId || $json.metadata?.publishRunId || $json.metadata?.eventData?.publishRunId, type: 'step_completed', platform: 'email', method: 'n8n', step: 'publish.submit', duration: 0, data: { messageId: $json.messageId || $json.id }, timestamp: $now.toISO() } }}",
      "options": {}
    },
    "position": [1960, 600],
    "typeVersion": 4.2
  },
  {
    "id": "platform-email-check-failed",
    "name": "‚ö†Ô∏è Email Publish Failed? (With Attachments)",
    "type": "if",
    "parameters": {
      "conditions": {
        "boolean": [
          {
            "value1": "={{ $json.error !== undefined || $json.errorMessage !== undefined || $json.success === false }}",
            "value2": true
          }
        ]
      }
    },
    "position": [1880, 560],
    "typeVersion": 2
  },
  {
    "id": "platform-email-check-failed-no-attachments",
    "name": "‚ö†Ô∏è Email Publish Failed? (No Attachments)",
    "type": "if",
    "parameters": {
      "conditions": {
        "boolean": [
          {
            "value1": "={{ $json.error !== undefined || $json.errorMessage !== undefined || $json.success === false }}",
            "value2": true
          }
        ]
      }
    },
    "position": [980, 760],
    "typeVersion": 2
  },
  {
    "id": "platform-email-emit-failed",
    "name": "‚ùå Emit Email Failed",
    "type": "httpRequest",
    "parameters": {
      "method": "POST",
      "url": "={{ $json.callbackUrl || $json.metadata?.callbackUrl || 'http://localhost:3000/api/publish/event' }}",
      "sendBody": true,
      "specifyBody": "json",
      "jsonBody": "={{ { sessionId: $json.sessionId || $json.metadata?.sessionId || $json.metadata?.eventData?.sessionId, publishRunId: $json.publishRunId || $json.metadata?.publishRunId || $json.metadata?.eventData?.publishRunId, type: 'step_failed', platform: 'email', method: 'n8n', step: 'publish.submit', error: $json.error?.message || $json.error || $json.errorMessage || 'Email publish failed', errorCode: 'N8N_NODE_ERROR', retryable: false, timestamp: $now.toISO() } }}",
      "options": {}
    },
    "position": [1960, 700],
    "typeVersion": 4.2
  },
  {
    "id": "platform-email-verify-emit-started",
    "name": "üì° Emit Email Verify Started",
    "type": "httpRequest",
    "parameters": {
      "method": "POST",
      "url": "={{ $json.callbackUrl || $json.metadata?.callbackUrl || 'http://localhost:3000/api/publish/event' }}",
      "sendBody": true,
      "specifyBody": "json",
      "jsonBody": "={{ { sessionId: $json.sessionId || $json.metadata?.sessionId || $json.metadata?.eventData?.sessionId, publishRunId: $json.publishRunId || $json.metadata?.publishRunId || $json.metadata?.eventData?.publishRunId, type: 'step_started', platform: 'email', method: 'n8n', step: 'publish.verify_result', message: 'Starting publish.verify_result via n8n', timestamp: $now.toISO() } }}",
      "options": {}
    },
    "position": [2140, 560],
    "typeVersion": 4.2
  },
  {
    "id": "platform-email-verify-check",
    "name": "üîé Verify Email Result",
    "type": "if",
    "parameters": {
      "conditions": {
        "boolean": [
          {
            "value1": "={{ $json.messageId !== undefined || $json.id !== undefined }}",
            "value2": true
          }
        ]
      }
    },
    "position": [2320, 580],
    "typeVersion": 2
  },
  {
    "id": "platform-email-verify-emit-completed",
    "name": "‚úÖ Emit Email Verify Completed",
    "type": "httpRequest",
    "parameters": {
      "method": "POST",
      "url": "={{ $json.callbackUrl || $json.metadata?.callbackUrl || 'http://localhost:3000/api/publish/event' }}",
      "sendBody": true,
      "specifyBody": "json",
      "jsonBody": "={{ { sessionId: $json.sessionId || $json.metadata?.sessionId || $json.metadata?.eventData?.sessionId, publishRunId: $json.publishRunId || $json.metadata?.publishRunId || $json.metadata?.eventData?.publishRunId, type: 'step_completed', platform: 'email', method: 'n8n', step: 'publish.verify_result', duration: 0, data: { verified: true }, timestamp: $now.toISO() } }}",
      "options": {}
    },
    "position": [2500, 540],
    "typeVersion": 4.2
  },
  {
    "id": "platform-email-verify-emit-failed",
    "name": "‚ùå Emit Email Verify Failed",
    "type": "httpRequest",
    "parameters": {
      "method": "POST",
      "url": "={{ $json.callbackUrl || $json.metadata?.callbackUrl || 'http://localhost:3000/api/publish/event' }}",
      "sendBody": true,
      "specifyBody": "json",
      "jsonBody": "={{ { sessionId: $json.sessionId || $json.metadata?.sessionId || $json.metadata?.eventData?.sessionId, publishRunId: $json.publishRunId || $json.metadata?.publishRunId || $json.metadata?.eventData?.publishRunId, type: 'step_failed', platform: 'email', method: 'n8n', step: 'publish.verify_result', error: 'Could not verify Email publish result', errorCode: 'VERIFY_RESULT_FAILED', retryable: false, timestamp: $now.toISO() } }}",
      "options": {}
    },
    "position": [2500, 640],
    "typeVersion": 4.2
  }
]
